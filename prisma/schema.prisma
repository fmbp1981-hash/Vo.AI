generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id            String         @id @default(cuid())
  name          String
  slug          String         @unique
  settings      String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  automations   Automation[]
  conversations Conversation[]
  itineraries   Itinerary[]
  leads         Lead[]
  proposals     Proposal[]
  tasks         Task[]
  users         User[]

  @@map("tenants")
}

model User {
  id                  String               @id @default(cuid())
  tenantId            String
  email               String
  name                String?
  password            String?
  role                String               @default("consultant")
  avatar              String?
  isActive            Boolean              @default(true)
  phoneNumber         String?
  notifyOnHandoff     Boolean              @default(true)
  lastLoginAt         DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  conversations       Conversation[]
  itineraries         Itinerary[]
  leads               Lead[]
  notifications       Notification[]
  passwordResetTokens PasswordResetToken[]
  proposals           Proposal[]
  tasks               Task[]
  tenant              Tenant               @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, email])
  @@map("users")
}

model Lead {
  id                    String         @id @default(cuid())
  tenantId              String
  userId                String?
  nome                  String
  status                String         @default("Novo Lead")
  telefone              String?
  telefoneNormalizado   String?
  dataNascimento        String?
  email                 String?
  canal                 String?
  destino               String?
  periodo               String?
  dataPartida           DateTime?
  dataRetorno           DateTime?
  orcamento             String?
  pessoas               String?
  ultimaMensagem        String?
  dataUltimaMensagem    DateTime?
  statusEnvio           String?
  processado            Boolean        @default(false)
  motivoCancelamento    String?
  qualificado           Boolean        @default(false)
  recorrente            Boolean        @default(false)
  estagio               String         @default("Novo Lead")
  updatedAt             DateTime       @updatedAt
  dataFechamento        DateTime?
  created               DateTime       @default(now())
  dataProcessamento     DateTime?
  observacoes           String?
  score                 Int            @default(0)
  source                String?
  tags                  String?
  notes                 String?
  assignedTo            String?
  assignedAt            DateTime?
  lastContactAt         DateTime?
  instagramId           String?
  tipoViagem            String?        @default("nacional")
  followUp2hEnviado     Boolean        @default(false)
  followUp4hEnviado     Boolean        @default(false)
  followUp1dEnviado     Boolean        @default(false)
  followUp2dEnviado     Boolean        @default(false)
  followUp30dEnviado    Boolean        @default(false)
  followUp45dEnviado    Boolean        @default(false)
  lembreteViagemEnviado Boolean        @default(false)
  lembrete7dEnviado     Boolean        @default(false)
  lembrete1dEnviado     Boolean        @default(false)
  lembreteDiaEnviado    Boolean        @default(false)
  feedbackEnviado       Boolean        @default(false)
  confirmacaoEnviada    Boolean        @default(false)
  conversations         Conversation[]
  followUps             FollowUp[]
  itineraries           Itinerary[]
  assignedUser          User?          @relation(fields: [assignedTo], references: [id])
  tenant                Tenant         @relation(fields: [tenantId], references: [id])
  proposals             Proposal[]
  tasks                 Task[]

  @@index([tenantId])
  @@map("leads")
}

model Conversation {
  id                 String    @id @default(cuid())
  tenantId           String
  leadId             String
  userId             String?
  channel            String
  messages           String
  status             String    @default("active")
  handoffMode        String    @default("ai")
  handoffReason      String?
  handoffRequestedAt DateTime?
  handoffAcceptedAt  DateTime?
  consultantNotified Boolean   @default(false)
  lastAiMessageAt    DateTime?
  lastHumanMessageAt DateTime?
  assignedAt         DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lead               Lead      @relation(fields: [leadId], references: [id])
  tenant             Tenant    @relation(fields: [tenantId], references: [id])
  user               User?     @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([handoffMode])
  @@map("conversations")
}

model Itinerary {
  id          String   @id @default(cuid())
  tenantId    String
  leadId      String
  userId      String
  title       String
  destination String
  startDate   DateTime
  endDate     DateTime
  budget      String?
  travelers   String?
  tripType    String?
  preferences String?
  content     String
  totalCost   Float?
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lead        Lead     @relation(fields: [leadId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@map("itineraries")
}

model Proposal {
  id         String    @id @default(cuid())
  tenantId   String
  leadId     String
  userId     String
  title      String
  content    String
  pdfUrl     String?
  totalValue Float?
  status     String    @default("draft")
  sentAt     DateTime?
  viewedAt   DateTime?
  signedAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lead       Lead      @relation(fields: [leadId], references: [id])
  tenant     Tenant    @relation(fields: [tenantId], references: [id])
  user       User      @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@map("proposals")
}

model Task {
  id          String    @id @default(cuid())
  tenantId    String
  leadId      String
  userId      String
  type        String
  title       String
  description String?
  priority    String    @default("medium")
  status      String    @default("pending")
  dueDate     DateTime
  completedAt DateTime?
  reminderAt  DateTime?
  remindedAt  DateTime?
  autoCreated Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lead        Lead      @relation(fields: [leadId], references: [id])
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@map("tasks")
}

model Automation {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  trigger     String
  conditions  String
  actions     String
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("automations")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model Activity {
  id          String   @id @default(cuid())
  userId      String
  type        String
  description String
  metadata    String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@map("activities")
}

model FollowUp {
  id           String    @id @default(cuid())
  leadId       String
  type         String
  message      String
  channel      String
  status       String    @default("pending")
  scheduledFor DateTime
  sentAt       DateTime?
  errorMessage String?
  metadata     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lead         Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([scheduledFor])
  @@index([status])
  @@map("follow_ups")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}
